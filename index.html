<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AgriMaster Pro v6.0 (Top Menu)</title>
    <style>
        /* --- VARIABLES & THEME --- */
        :root {
            --primary: #2e7d32; --primary-dark: #1b5e20; --accent: #fbc02d;
            --bg-app: #f0f2f5; --bg-card: #ffffff; --text: #333; --text-muted: #888;
            --success: #27ae60; --danger: #e74c3c; --info: #2980b9; --warning: #f39c12;
            --shadow: 0 4px 15px rgba(0,0,0,0.08); --radius: 16px;
            --glass: rgba(255, 255, 255, 0.9);
        }

        /* DARK MODE */
        [data-theme="dark"] {
            --bg-app: #121212; --bg-card: #1e1e1e; --text: #f0f0f0; --text-muted: #aaa;
            --glass: rgba(30, 30, 30, 0.9);
        }

        /* --- RESET & BASE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-app); color: var(--text); padding-bottom: 20px; overflow-x: hidden; transition: background 0.3s, color 0.3s; }
        
        /* --- LAYOUT --- */
        #app-container { max-width: 800px; margin: 0 auto; min-height: 100vh; position: relative; }
        
        /* --- HEADER & TOP NAV --- */
        .topbar {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; padding: 20px;
            border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; 
            box-shadow: 0 10px 20px rgba(46, 125, 50, 0.3);
            display: flex; flex-direction: column; /* Changed to column for title + menu */
            align-items: center; margin-bottom: 20px;
            position: sticky; top: 0; z-index: 100;
        }
        .user-wallet { background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; backdrop-filter: blur(5px); font-size: 0.9rem; margin-top: 5px; }

        /* NEW: TOP NAVIGATION STYLE */
        .top-nav { 
            display: flex; gap: 10px; overflow-x: auto; padding-top: 15px; width: 100%; 
            -ms-overflow-style: none; scrollbar-width: none; 
        }
        .top-nav::-webkit-scrollbar { display: none; }
        
        .nav-item { 
            flex: 0 0 auto; /* Prevent shrinking */
            padding: 8px 16px; border-radius: 20px; 
            background: rgba(255,255,255,0.2); 
            color: white; font-size: 0.85rem; font-weight: 600; cursor: pointer; 
            white-space: nowrap; transition: 0.3s; border: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-item.active { background: var(--accent); color: black; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border-color: var(--accent); font-weight: bold; }
        .nav-icon { font-size: 1.1rem; }
        .nav-label { font-size: 0.7rem; }

        /* --- VIEWS --- */
        .view-section { display: none; padding: 0 16px; animation: fadeUp 0.4s ease; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS --- */
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.03); }
        .card-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* --- DASHBOARD STATS --- */
        .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .stat-card { background: var(--glass); padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); backdrop-filter: blur(10px); }
        .stat-val { font-size: 1.4rem; font-weight: 800; color: var(--primary); }
        .stat-lbl { font-size: 0.8rem; color: var(--text-muted); }

        /* --- WEATHER WIDGET --- */
        .weather-card { background: linear-gradient(to right, #4facfe, #00f2fe); color: white; border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }

        /* --- CHART AREA --- */
        .chart-container { width: 100%; height: 150px; position: relative; background: var(--glass); border-radius: 12px; display: flex; align-items: flex-end; padding: 10px; overflow: hidden; border: 1px dashed #ddd; }
        .chart-bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; margin: 0 2px; height: 100%; justify-content: flex-end; }
        .chart-bar { width: 100%; background: var(--primary); border-radius: 4px 4px 0 0; min-height: 2px; transition: height 1s; opacity: 0.8; }
        .chart-label { font-size: 0.6rem; margin-top: 4px; color: var(--text-muted); }

        /* --- LIST ITEMS --- */
        .list-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .list-row:last-child { border-bottom: none; }
        .icon-box { width: 40px; height: 40px; background: rgba(46, 125, 50, 0.1); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 12px; }
        .text-box { flex: 1; }
        .title { font-weight: 600; font-size: 1rem; }
        .sub { font-size: 0.8rem; color: var(--text-muted); }
        .action-btn { color: var(--primary); font-weight: bold; font-size: 0.9rem; background: none; border: none; cursor: pointer; }

        /* --- PROGRESS BAR --- */
        .progress-track { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.5s ease; }

        /* --- TASKS / TIMELINE --- */
        .task-item { display: flex; align-items: center; padding: 8px 0; font-size: 0.9rem; border-bottom: 1px solid #f5f5f5; }
        .task-item.done span { text-decoration: line-through; color: #aaa; }
        .checkbox { width: 18px; height: 18px; border: 2px solid var(--primary); border-radius: 4px; margin-right: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .checkbox.checked::after { content: '‚úî'; font-size: 12px; color: white; }
        .checkbox.checked { background: var(--primary); }

        /* TIMELINE */
        .timeline { position: relative; padding-left: 20px; border-left: 2px solid #e5e7eb; margin-top: 15px; }
        [data-theme="dark"] .timeline { border-left-color: #374151; }
        .timeline-item { position: relative; margin-bottom: 20px; }
        .timeline-dot { position: absolute; left: -26px; top: 0; width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--bg-card); box-shadow: 0 0 0 2px #ccc; }
        .timeline-content { font-size: 0.9rem; }
        .timeline-item.done .timeline-dot { background: var(--primary); box-shadow: 0 0 0 2px var(--primary); }
        .timeline-item.done .t-title { color: var(--text-muted); text-decoration: line-through; }
        .timeline-item.active .timeline-dot { background: var(--accent); box-shadow: 0 0 0 4px rgba(251, 191, 36, 0.3); animation: pulse 1.5s infinite; }
        .timeline-item.active .t-title { color: var(--primary-dark); font-weight: 800; background: rgba(251, 191, 36, 0.2); padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .timeline-item.future .timeline-dot { background: #e5e7eb; }
        [data-theme="dark"] .timeline-item.future .timeline-dot { background: #374151; }
        .t-hst { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        /* --- BUTTONS --- */
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; width: 100%; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3); }
        .btn-primary:active { transform: scale(0.98); }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; }
        
        /* --- FAB --- */
        .fab { position: fixed; bottom: 20px; right: 20px; background: var(--accent); color: black; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 5px 15px rgba(251, 192, 45, 0.5); cursor: pointer; z-index: 90; }

        /* --- MODAL --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-box { background: var(--bg-card); width: 90%; max-width: 400px; border-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto; animation: zoomIn 0.3s; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- INPUTS & FORMS --- */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-muted); }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; outline: none; background: var(--bg-card); color: var(--text); }
        .form-input:focus { border-color: var(--primary); }
        select.form-input { background: var(--bg-card); }

        /* --- TOOLS SECTION --- */
        .tool-selector { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; -ms-overflow-style: none; scrollbar-width: none; }
        .tool-selector::-webkit-scrollbar { display: none; }
        .tool-chip { padding: 8px 15px; background: var(--bg-app); border-radius: 20px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; border: 1px solid rgba(0,0,0,0.1); }
        .tool-chip.active { background: var(--accent); color: black; font-weight: bold; border-color: var(--accent); }
        .calc-result { background: var(--primary); color: white; padding: 15px; border-radius: 12px; margin-top: 15px; display: none; }

        /* --- UTILITY --- */
        .hidden { display: none; }
        .text-accent { color: var(--accent); }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; background: #eee; }
        .badge.active { background: #e3f2fd; color: #1565c0; }
        .badge.done { background: #e8f5e9; color: #2e7d32; }
        .badge.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>

<div id="app-container">

    <!-- HEADER DENGAN MENU ATAS -->
    <div class="topbar">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="font-size:1.4rem;">AgriMaster Pro</h2>
            <div class="user-wallet">üí∞ <span id="wallet-balance">0</span></div>
        </div>
        
        <!-- MENU NAVIGASI DI ATAS (PERBAIKAN) -->
        <div class="top-nav">
            <button class="nav-item active" onclick="nav.to('dashboard')" id="nav-dashboard">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Home</span>
            </button>
            <button class="nav-item" onclick="nav.to('lahan')" id="nav-lahan">
                <span class="nav-icon">üå±</span>
                <span class="nav-label">Lahan</span>
            </button>
            <button class="nav-item" onclick="nav.to('katalog')" id="nav-katalog">
                <span class="nav-icon">üìñ</span>
                <span class="nav-label">Katalog</span>
            </button>
            <button class="nav-item" onclick="nav.to('alat')" id="nav-alat">
                <span class="nav-icon">‚öíÔ∏è</span>
                <span class="nav-label">Alat</span>
            </button>
            <button class="nav-item" onclick="nav.to('pengaturan')" id="nav-pengaturan">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Menu</span>
            </button>
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="view-section active">
        <!-- Weather Widget -->
        <div class="weather-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-size: 2rem; font-weight: bold;">Cerah</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">Cocok untuk penyiangan & pemupukan</div>
                </div>
                <div style="font-size: 3rem;">‚òÄÔ∏è</div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-val" id="dash-fields">0</div>
                <div class="stat-lbl">Lahan Aktif</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="dash-expense">Rp 0</div>
                <div class="stat-lbl">Total Biaya</div>
            </div>
            <div class="stat-card">
                <div class="stat-val" id="dash-harvests">0</div>
                <div class="stat-lbl">Total Panen</div>
            </div>
        </div>

        <!-- Active Fields -->
        <div class="card">
            <div class="card-title">üå± Lahan Aktif</div>
            <div id="dashboard-fields"></div>
        </div>

        <!-- Recent Activities -->
        <div class="card">
            <div class="card-title">üìù Aktivitas Terakhir</div>
            <div id="activity-feed"></div>
        </div>
    </div>

    <!-- LAHAN VIEW -->
    <div id="view-lahan" class="view-section">
        <div class="card">
            <button class="btn btn-primary" onclick="modal.open('modal-field')">‚ûï Tambah Lahan Baru</button>
        </div>
        <div id="fields-list"></div>
    </div>

    <!-- KATALOG VIEW -->
    <div id="view-katalog" class="view-section">
        <input type="text" id="search-catalog" class="form-input" placeholder="üîç Cari tanaman..." style="margin-bottom:15px;" onkeyup="catalog.render()">
        <div id="catalog-list"></div>
        <div class="fab" onclick="modal.open('modal-plant')">+</div>
    </div>

    <!-- ALAT VIEW -->
    <div id="view-alat" class="view-section">
        <div class="tool-selector">
            <div class="tool-chip active" onclick="tools.setTab(0)">Benih</div>
            <div class="tool-chip" onclick="tools.setTab(1)">Pupuk</div>
            <div class="tool-chip" onclick="tools.setTab(2)">Obat HPT</div>
            <div class="tool-chip" onclick="tools.setTab(3)">NPK Calculator</div>
        </div>
        
        <!-- Benih Calculator -->
        <div id="tool-0" class="card">
            <h3>Kalkulator Kebutuhan Benih</h3>
            <div class="input-group">
                <label>Pilih Tanaman:</label>
                <select id="cb-t" class="form-input"></select>
            </div>
            <div class="input-group">
                <label>Luas Lahan (m¬≤):</label>
                <input type="number" id="cb-l" class="form-input" placeholder="Contoh: 1000">
            </div>
            <button class="btn btn-primary" onclick="tools.calcBenih()">Hitung Kebutuhan</button>
            <div id="res-benih" class="calc-result"></div>
        </div>

        <!-- Pupuk Calculator -->
        <div id="tool-1" class="card" style="display:none;">
            <h3>Kalkulator Kebutuhan Pupuk</h3>
            <div class="input-group">
                <label>Pilih Tanaman:</label>
                <select id="cp-t" class="form-input"></select>
            </div>
            <div class="input-group">
                <label>Luas Lahan (m¬≤):</label>
                <input type="number" id="cp-l" class="form-input">
            </div>
            <button class="btn btn-primary" onclick="tools.calcPupuk()">Hitung Kebutuhan</button>
            <div id="res-pupuk" class="calc-result"></div>
        </div>

        <!-- HPT Calculator -->
        <div id="tool-2" class="card" style="display:none;">
            <h3>Kalkulator Obat Hama & Penyakit</h3>
            <div class="input-group">
                <label>Volume Tangki (Liter):</label>
                <input type="number" id="ch-t" class="form-input" placeholder="Contoh: 15">
            </div>
            <div class="input-group">
                <label>Dosis Obat (ml/Liter air):</label>
                <input type="number" id="ch-d" class="form-input" placeholder="Contoh: 2">
            </div>
            <button class="btn btn-primary" onclick="tools.calcHPT()">Hitung Campuran</button>
            <div id="res-hpt" class="calc-result"></div>
        </div>

        <!-- NPK Calculator -->
        <div id="tool-3" class="card" style="display:none;">
            <h3>Kalkulator Kebutuhan NPK</h3>
            <div class="input-group">
                <label>Pilih Tanaman:</label>
                <select id="cn-t" class="form-input"></select>
            </div>
            <div class="input-group">
                <label>Luas Lahan (hektar):</label>
                <input type="number" id="cn-l" class="form-input" placeholder="Contoh: 1">
            </div>
            <button class="btn btn-primary" onclick="tools.calcNPK()">Hitung Kebutuhan NPK</button>
            <div id="res-npk" class="calc-result"></div>
        </div>
    </div>

    <!-- PENGATURAN VIEW -->
    <div id="view-pengaturan" class="view-section">
        <div class="card">
            <div class="card-title">‚öôÔ∏è Pengaturan Aplikasi</div>
            
            <div class="list-row">
                <div class="icon-box">üåô</div>
                <div class="text-box">
                    <div class="title">Tema Aplikasi</div>
                    <div class="sub">Ganti tampilan gelap/terang</div>
                </div>
                <button class="action-btn" onclick="app.toggleTheme()">Ganti Tema</button>
            </div>
            
            <div class="list-row">
                <div class="icon-box">üíæ</div>
                <div class="text-box">
                    <div class="title">Backup Data</div>
                    <div class="sub">Simpan data ke file JSON</div>
                </div>
                <button class="action-btn" onclick="dataMgr.backup()">Download</button>
            </div>
            
            <div class="list-row">
                <div class="icon-box">üìÇ</div>
                <div class="text-box">
                    <div class="title">Restore Data</div>
                    <div class="sub">Kembalikan data dari file</div>
                </div>
                <input type="file" id="restore-file" accept=".json" style="display:none" onchange="dataMgr.restore(this)">
                <button class="action-btn" onclick="document.getElementById('restore-file').click()">Upload</button>
            </div>

            <div class="list-row" style="margin-top:15px;">
                <div class="icon-box" style="background:rgba(231, 76, 60, 0.1);">‚ö†Ô∏è</div>
                <div class="text-box">
                    <div class="title" style="color:var(--danger)">Reset Aplikasi</div>
                    <div class="sub">Hapus semua data dan reset ke default</div>
                </div>
                <button class="action-btn" style="color:var(--danger)" onclick="app.resetApp()">Reset</button>
            </div>
        </div>
    </div>

</div>

<!-- MODAL: ADD FIELD -->
<div id="modal-field" class="modal">
    <div class="modal-box">
        <h3>üìù Tambah Lahan Baru</h3>
        <div class="input-group">
            <label>Nama Lahan / Blok</label>
            <input type="text" id="f-name" class="form-input" placeholder="Blok A Utama">
        </div>
        <div class="input-group">
            <label>Pilih Tanaman</label>
            <select id="f-plant" class="form-input"></select>
        </div>
        <div class="input-group">
            <label>Tanggal Tanam</label>
            <input type="date" id="f-date" class="form-input">
        </div>
        <div class="input-group">
            <label>Luas (m¬≤)</label>
            <input type="number" id="f-area" class="form-input" placeholder="1000">
        </div>
        <div class="input-group">
            <label>Jenis Biaya</label>
            <select id="f-type" class="form-input">
                <option value="seed">Bibit & Tanam</option>
                <option value="fert">Pupuk & Obat</option>
                <option value="labor">Gaji Tenaga</option>
                <option value="other">Lain-lain</option>
            </select>
        </div>
        <div class="input-group">
            <label>Biaya Awal (Rp)</label>
            <input type="number" id="f-cost" class="form-input" placeholder="500000">
        </div>
        <button class="btn btn-primary" onclick="app.addField()">Simpan Lahan</button>
        <button class="btn btn-outline" style="margin-top:10px;" onclick="modal.close()">Batal</button>
    </div>
</div>

<!-- MODAL: FIELD DETAILS -->
<div id="modal-detail" class="modal">
    <div class="modal-box">
        <div id="detail-header"></div>
        
        <div style="margin: 15px 0; padding:10px; background:var(--glass); border-radius:10px;">
            <h4 style="margin-bottom:10px;">üìÖ Jadwal Tanam</h4>
            <div id="d-timeline" class="timeline"></div>
        </div>

        <div style="margin: 15px 0; padding:10px; background:var(--glass); border-radius:10px;">
            <h4 style="margin-bottom:10px;">üìã Daftar Tugas</h4>
            <div id="task-list"></div>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <input type="text" id="new-task-input" class="form-input" placeholder="Tambah tugas baru..." style="font-size:0.8rem; padding:8px;">
                <button class="btn btn-primary" style="width:auto; padding:8px 12px;" onclick="app.addTask()">‚ûï</button>
            </div>
        </div>

        <button class="btn btn-primary" onclick="app.initHarvest()">üåΩ Lakukan Panen</button>
        <button class="btn btn-outline" style="margin-top:10px;" onclick="modal.close()">Tutup</button>
    </div>
</div>

<!-- MODAL: PLANT INFO -->
<div id="modal-plant-info" class="modal">
    <div class="modal-box">
        <h3 id="pi-name">Nama Tanaman</h3>
        <p id="pi-desc" style="color:var(--text-muted); font-size:0.9rem; margin-bottom:15px;"></p>
        <div id="pi-timeline" style="margin-top:15px;"></div>
        <button class="btn btn-primary" style="margin-top:15px;" onclick="modal.close()">Tutup</button>
    </div>
</div>

<!-- MODAL: ADD PLANT -->
<div id="modal-plant" class="modal">
    <div class="modal-box">
        <h3>üå± Tambah Tanaman Baru</h3>
        <div class="input-group">
            <label>Nama Tanaman</label>
            <input type="text" id="p-name" class="form-input" placeholder="Contoh: Padi Ciherang">
        </div>
        <div class="input-group">
            <label>Harga Jual Estimasi (per Kg)</label>
            <input type="number" id="p-price" class="form-input" placeholder="10000">
        </div>
        <div class="input-group">
            <label>Hari Panen (HST)</label>
            <input type="number" id="p-days" class="form-input" placeholder="90">
        </div>
        <div class="input-group">
            <label>Kebutuhan Benih per m¬≤</label>
            <input type="number" id="p-seeds" class="form-input" placeholder="0.2" step="0.01">
        </div>
        <div class="input-group">
            <label>Kategori</label>
            <select id="p-cat" class="form-input">
                <option value="Pangan">Pangan</option>
                <option value="Sayur">Sayur</option>
                <option value="Buah">Buah</option>
                <option value="Pohon">Pohon</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="app.addPlant()">Simpan Tanaman</button>
        <button class="btn btn-outline" style="margin-top:10px;" onclick="modal.close()">Batal</button>
    </div>
</div>

<script>
    // --- DATABASE & INITIAL DATA ---
    const defaultCatalog = [
        { 
            id: 1, name: "Padi Sawah", cat: "Pangan", days: 120, price: 12000, icon: "üåæ",
            desc: "Tanaman pangan utama Indonesia, membutuhkan genangan air di fase awal.",
            schedule: [
                {hst: 0, task: "Tanam Benih"}, {hst: 15, task: "Pemupukan I (Urea)"}, 
                {hst: 30, task: "Pemupukan II (NPK)"}, {hst: 45, task: "Pemupukan III (KCl)"}, 
                {hst: 120, task: "Panen"}
            ], 
            seeds: 200, npk: {n: 150, p: 50, k: 100}, pupuk: {u: 0.1, tsp: 0.05, kcl: 0.05}
        },
        { 
            id: 2, name: "Jagung Manis", cat: "Pangan", days: 75, price: 8000, icon: "üåΩ",
            desc: "Tanaman serealia cepat panen, membutuhkan sinar matahari penuh.",
            schedule: [
                {hst: 0, task: "Tanam Benih"}, {hst: 20, task: "Pemupukan (NPK)"}, 
                {hst: 40, task: "Pemupukan Susulan (Urea)"}, {hst: 75, task: "Panen"}
            ], 
            seeds: 0.2, npk: {n: 200, p: 70, k: 100}, pupuk: {u: 0.15, tsp: 0.05, kcl: 0.1}
        },
        { 
            id: 3, name: "Cabai Rawit", cat: "Sayur", days: 90, price: 45000, icon: "üå∂Ô∏è",
            desc: "Komoditas hortik bernilai tinggi, rentan terhadap penyakit busuk buah.",
            schedule: [
                {hst: 0, task: "Tanam Bibit"}, {hst: 15, task: "Pemupukan Dasar"}, 
                {hst: 30, task: "Perawatan & Semprot Hama"}, {hst: 60, task: "Pembungaan"}, 
                {hst: 90, task: "Panen"}
            ], 
            seeds: 0.1, npk: {n: 250, p: 80, k: 150}, pupuk: {u: 0.1, tsp: 0.05, kcl: 0.15}
        },
        { 
            id: 4, name: "Tomat", cat: "Sayur", days: 100, price: 10000, icon: "üçÖ",
            desc: "Sayuran buah kaya vitamin, butuh ajir penyangga agar batang tidak patah.",
            schedule: [
                {hst: 0, task: "Tanam & Pasang Ajir"}, {hst: 20, task: "Pemupukan & Sulur"}, 
                {hst: 50, task: "Pemupukan Bunga"}, {hst: 100, task: "Panen Merah"}
            ], 
            seeds: 0.1, npk: {n: 200, p: 60, k: 120}, pupuk: {u: 0.1, tsp: 0.05, kcl: 0.12}
        },
        { 
            id: 5, name: "Sawi Sendok", cat: "Sayur", days: 35, price: 15000, icon: "ü•¨",
            desc: "Sayuran daun cepat panen, cocok untuk dataran tinggi.",
            schedule: [
                {hst: 0, task: "Tabur Benih"}, {hst: 10, task: "Penjarangan"}, 
                {hst: 20, task: "Pemupukan N"}, {hst: 35, task: "Panen"}
            ], 
            seeds: 0.15, npk: {n: 120, p: 40, k: 80}, pupuk: {u: 0.08, tsp: 0.03, kcl: 0.05}
        },
        { 
            id: 6, name: "Wortel", cat: "Sayur", days: 90, price: 12000, icon: "ü•ï",
            desc: "Akar umbi sehat, tanah harus gembur dan bebas batu.",
            schedule: [
                {hst: 0, task: "Tabur Benih (Halus)"}, {hst: 15, task: "Penjarangan"}, 
                {hst: 30, task: "Pemupukan N"}, {hst: 90, task: "Cubit Umbi"}
            ], 
            seeds: 0.2, npk: {n: 150, p: 50, k: 100}, pupuk: {u: 0.08, tsp: 0.05, kcl: 0.08}
        }
    ];

    let data = JSON.parse(localStorage.getItem('agriMasterPro_v6_topnav')) || {
        wallet: 0,
        catalog: defaultCatalog,
        fields: [],
        harvests: [],
        expenses: 0,
        theme: 'dark'
    };

    let currentFieldId = null;

    // --- SAVE FUNCTION ---
    function save() { localStorage.setItem('agriMasterPro_v6_topnav', JSON.stringify(data)); app.refresh(); }

    // --- NAVIGATION ---
    const nav = {
        to: (view) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + view).classList.add('active');
            document.getElementById('nav-' + view).classList.add('active');
            if(view === 'dashboard') app.renderDashboard();
            if(view === 'alat') tools.init();
        }
    };

    const modal = {
        open: (id) => document.getElementById(id).classList.add('active'),
        close: () => document.querySelectorAll('.modal').forEach(el => el.classList.remove('active'))
    };

    // --- APP LOGIC ---
    const app = {
        init: () => {
            // Set Theme (Default Dark requested previously)
            document.documentElement.setAttribute('data-theme', data.theme || 'dark');
            tools.init();
            app.refresh();
            document.getElementById('f-date').valueAsDate = new Date();
        },

        toggleTheme: () => {
            data.theme = data.theme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', data.theme);
            save();
        },

        refresh: () => {
            app.renderDashboard();
            app.renderFields();
            catalog.render();
            document.getElementById('wallet-balance').innerText = data.wallet.toLocaleString('id-ID');
        },

        renderDashboard: () => {
            const activeFields = data.fields.filter(f => f.status === 'active').length;
            document.getElementById('dash-fields').innerText = activeFields;
            document.getElementById('dash-harvests').innerText = data.harvests.length;
            
            let totalExpense = 0;
            data.fields.forEach(f => totalExpense += (f.cost || 0));
            document.getElementById('dash-expense').innerText = 'Rp ' + totalExpense.toLocaleString('id-ID');

            // Active Fields List (Top 3)
            const dashFields = document.getElementById('dashboard-fields');
            dashFields.innerHTML = '';
            const active = data.fields.filter(f => f.status === 'active').slice(0, 3);
            
            if(active.length === 0) {
                dashFields.innerHTML = '<p style="text-align:center; color:#999; padding:10px;">Belum ada lahan aktif</p>';
            } else {
                active.forEach(f => {
                    const start = new Date(f.datePlanted);
                    const now = new Date();
                    const diff = Math.ceil(Math.abs(now - start) / (1000 * 60 * 60 * 24));
                    const pct = Math.min(100, Math.round((diff / f.days) * 100));
                    
                    dashFields.innerHTML += `
                        <div class="list-row" onclick="app.openDetail(${f.id})">
                            <div class="icon-box">${f.plantIcon}</div>
                            <div class="text-box">
                                <div class="title">${f.name}</div>
                                <div class="sub">${f.plantName} ‚Ä¢ ${diff} HST</div>
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: ${pct}%"></div>
                                </div>
                            </div>
                            <span class="badge ${pct >= 90 ? 'warning' : 'active'}">${pct}%</span>
                        </div>
                    `;
                });
            }

            // Activity Feed
            const feed = document.getElementById('activity-feed');
            feed.innerHTML = '';
            const recentActivities = [
                ...data.harvests.map(h => ({...h, type: 'harvest'})),
                ...data.fields.filter(f => f.status === 'active').map(f => ({type: 'field', name: f.name, date: f.datePlanted}))
            ]
            .sort((a,b) => new Date(b.date) - new Date(a.date))
            .slice(0, 5);

            if(recentActivities.length === 0) {
                feed.innerHTML = '<p style="text-align:center; color:#999; font-size:0.8rem;">Belum ada aktivitas.</p>';
            } else {
                recentActivities.forEach(act => {
                    if(act.type === 'harvest') {
                        feed.innerHTML += `
                            <div class="list-row">
                                <div class="icon-box" style="background:rgba(39, 174, 96, 0.1);">üí∞</div>
                                <div class="text-box">
                                    <div class="title">Panen ${act.plant}</div>
                                    <div class="sub">${act.date} ‚Ä¢ ${act.amount} Kg</div>
                                </div>
                                <span style="font-size:0.8rem; font-weight:bold; color:var(--success);">+${act.income}</span>
                            </div>`;
                    } else {
                        feed.innerHTML += `
                            <div class="list-row">
                                <div class="icon-box" style="background:rgba(46, 125, 50, 0.1);">üå±</div>
                                <div class="text-box">
                                    <div class="title">Lahan ${act.name} dibuat</div>
                                    <div class="sub">${act.date}</div>
                                </div>
                            </div>`;
                    }
                });
            }
        },

        renderFields: () => {
            const list = document.getElementById('fields-list');
            list.innerHTML = '';
            const active = data.fields.filter(f => f.status === 'active');

            if(active.length === 0) {
                list.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Tidak ada lahan aktif. Buat lahan baru untuk memulai.</p>';
                return;
            }

            active.forEach(f => {
                const start = new Date(f.datePlanted);
                const now = new Date();
                const diff = Math.ceil(Math.abs(now - start) / (1000 * 60 * 60 * 24));
                const pct = Math.min(100, Math.round((diff / f.days) * 100));

                list.innerHTML += `
                    <div class="card" onclick="app.openDetail(${f.id})">
                        <div class="card-title">
                            <span>${f.plantIcon} ${f.name}</span>
                            <span class="badge ${pct >= 90 ? 'warning' : 'active'}">${pct}%</span>
                        </div>
                        <div class="sub">${f.plantName} ‚Ä¢ ${f.area} m¬≤ ‚Ä¢ ${diff} HST</div>
                        <div class="sub">Biaya: Rp ${(f.cost || 0).toLocaleString('id-ID')}</div>
                        <div class="progress-track">
                            <div class="progress-fill" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            });
        },

        populatePlantSelect: () => {
            const sel = document.getElementById('f-plant');
            sel.innerHTML = '';
            data.catalog.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
        },

        addField: () => {
            const name = document.getElementById('f-name').value;
            const pid = document.getElementById('f-plant').value;
            const date = document.getElementById('f-date').value;
            const area = document.getElementById('f-area').value;
            const type = document.getElementById('f-type').value;
            const cost = document.getElementById('f-cost').value;
            
            if(!name || !date || !area) return;
            const p = data.catalog.find(x=>x.id==pid);
            
            data.fields.push({
                id: Date.now(),
                name,
                plantId: pid,
                plantName: p.name,
                plantIcon: p.icon,
                days: p.days,
                price: p.price,
                datePlanted: date,
                area,
                type,
                cost: parseInt(cost || 0),
                status: 'active',
                tasks: [
                    { id: 1, text: 'Penyiapan lahan dan pengolahan tanah', done: false },
                    { id: 2, text: 'Penanaman bibit/benih', done: true },
                    { id: 3, text: 'Penyiraman rutin', done: false },
                    { id: 4, text: 'Pemupukan pertama', done: false }
                ]
            });

            data.expenses += parseInt(cost) || 0;
            save();
            modal.close();
            app.refresh();
        },

        addPlant: () => {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const days = document.getElementById('p-days').value;
            const seeds = document.getElementById('p-seeds').value;
            const cat = document.getElementById('p-cat').value;

            if(!name || !price) { alert('Lengkapi data!'); return; }

            data.catalog.push({
                id: Date.now(),
                name,
                price: parseInt(price),
                days: parseInt(days),
                seeds: parseFloat(seeds) || 0.1,
                cat,
                icon: cat === 'Pohon' ? 'üå≥' : cat === 'Buah' ? 'üçé' : cat === 'Sayur' ? 'ü•¨' : 'üåæ',
                desc: "Tanaman custom yang ditambahkan pengguna",
                schedule: [
                    {hst: 0, task: "Persiapan Lahan & Tanam"},
                    {hst: Math.floor(parseInt(days)/3), task: "Pemupukan Pertama"},
                    {hst: Math.floor(parseInt(days)*2/3), task: "Perawatan & Pengendalian Hama"},
                    {hst: parseInt(days), task: "Panen"}
                ],
                npk: {n: 150, p: 50, k: 100},
                pupuk: {u: 0.1, tsp: 0.05, kcl: 0.05}
            });

            save();
            modal.close();
            catalog.render();
            alert('Tanaman berhasil ditambahkan!');
        },

        openDetail: (fid) => {
            currentFieldId = fid;
            const f = data.fields.find(x=>x.id===fid);
            const p = data.catalog.find(x=>x.id==f.plantId);
            
            // Calc Age
            const start = new Date(f.datePlanted);
            const now = new Date();
            const age = Math.ceil(Math.abs(now - start) / (1000 * 60 * 60 * 24));

            document.getElementById('detail-header').innerHTML = `
                <h2>${f.plantIcon} ${f.name}</h2>
                <p class="sub">${f.plantName} - ${f.area} m¬≤</p>
                <p class="sub">Tanggal Tanam: ${f.datePlanted} ‚Ä¢ Umur: <strong style="color:var(--primary); font-size:1.1rem;">${age} HST</strong></p>
            `;

            // Render Timeline
            const tlContainer = document.getElementById('d-timeline');
            tlContainer.innerHTML = '';
            if(p.schedule) {
                p.schedule.forEach((item, idx) => {
                    let statusClass = 'future';
                    if(age >= item.hst) statusClass = 'done';
                    else if(idx > 0 && age < item.hst && age >= p.schedule[idx-1].hst) statusClass = 'active';
                    
                    const el = document.createElement('div');
                    el.className = `timeline-item ${statusClass}`;
                    el.innerHTML = `
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="t-title">${item.task}</div>
                            <div class="t-hst">${item.hst} HST</div>
                        </div>
                    `;
                    tlContainer.appendChild(el);
                });
            } else {
                tlContainer.innerHTML = '<p style="font-size:0.8rem; color:#999;">Tidak ada jadwal bawaan.</p>';
            }

            app.renderTasks(f.tasks);
            modal.open('modal-detail');
        },

        renderTasks: (tasks) => {
            const container = document.getElementById('task-list');
            container.innerHTML = '';
            tasks.forEach((t, idx) => {
                container.innerHTML += `
                    <div class="task-item ${t.done ? 'done' : ''}" onclick="app.toggleTask(${idx})">
                        <div class="checkbox ${t.done ? 'checked' : ''}"></div>
                        <span>${t.text}</span>
                    </div>
                `;
            });
        },

        addTask: () => {
            const input = document.getElementById('new-task-input');
            if(!input.value) return;
            const f = data.fields.find(x=>x.id===currentFieldId);
            f.tasks.push({ id: Date.now(), text: input.value, done: false });
            input.value = '';
            save();
            app.openDetail(currentFieldId);
        },

        toggleTask: (idx) => {
            const f = data.fields.find(x=>x.id===currentFieldId);
            f.tasks[idx].done = !f.tasks[idx].done;
            save();
            app.openDetail(currentFieldId);
        },

        initHarvest: () => {
            const f = data.fields.find(x=>x.id===currentFieldId);
            const amount = prompt(`Masukkan jumlah hasil panen ${f.plantName} (Kg):`, "100");
            if(!amount || isNaN(amount)) return;
            
            const income = amount * f.price;
            
            if(confirm(`Estimasi Pendapatan: Rp ${income.toLocaleString('id-ID')}\nLanjutkan panen?`)) {
                f.status = 'harvested';
                data.wallet += parseInt(income);
                
                data.harvests.unshift({
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    plant: f.plantName,
                    amount: parseFloat(amount),
                    income: income,
                    fieldId: f.id
                });

                save();
                modal.close();
                alert("‚úÖ Panen Tercatat! Saldo bertambah.");
            }
        },

        resetApp: () => {
            if(confirm("‚ö†Ô∏è PERINGATAN: Semua data akan dihapus permanen!\n\nData lahan, panen, dan kustomisasi akan hilang.\nYakin ingin reset?")) {
                localStorage.clear();
                location.reload();
            }
        }
    };

    // --- CATALOG LOGIC ---
    const catalog = {
        render: () => {
            const term = document.getElementById('search-catalog').value.toLowerCase();
            const list = document.getElementById('catalog-list');
            list.innerHTML = '';
            
            const filtered = data.catalog.filter(p => 
                p.name.toLowerCase().includes(term) || 
                p.cat.toLowerCase().includes(term)
            );

            if(filtered.length === 0) {
                list.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">Tanaman tidak ditemukan</p>';
                return;
            }

            filtered.forEach(p => {
                list.innerHTML += `
                    <div class="card" onclick="catalog.showInfo(${p.id})">
                        <div class="list-row">
                            <div class="icon-box">${p.icon}</div>
                            <div class="text-box">
                                <div class="title">${p.name}</div>
                                <div class="sub">${p.desc}</div>
                                <div class="sub" style="color:var(--primary); margin-top:5px;">Umur: ${p.days} Hari ‚Ä¢ Rp ${p.price}/kg</div>
                            </div>
                        </div>
                    </div>
                `;
            });
        },

        showInfo: (id) => {
            const p = data.catalog.find(x=>x.id===id);
            document.getElementById('pi-name').innerText = p.name;
            document.getElementById('pi-desc').innerText = p.desc || "Tidak ada deskripsi.";
            
            // Show schedule reference
            const tl = document.getElementById('pi-timeline');
            if(p.schedule) {
                tl.innerHTML = `<h4 style="margin-bottom:10px;">Jadwal Referensi:</h4>` + 
                p.schedule.map(s => `<div style="margin-bottom:5px; font-size:0.9rem; padding:5px; background:var(--glass); border-radius:5px;">‚Ä¢ <b>${s.hst} HST:</b> ${s.task}</div>`).join('');
            } else {
                tl.innerHTML = '';
            }
            modal.open('modal-plant-info');
        }
    };

    // --- TOOLS LOGIC ---
    const tools = {
        init: () => {
            const opts = data.catalog.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            ['cb-t','cp-t','cn-t'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = opts;
            });
        },
        setTab: (i) => {
            document.querySelectorAll('.tool-chip').forEach((e,x)=>e.classList.toggle('active',x===i));
            [0,1,2,3].forEach(x => {
                const el = document.getElementById(`tool-${x}`);
                if(el) el.style.display = x===i?'block':'none';
            });
        },
        calcBenih: () => {
            const p = data.catalog.find(x=>x.id==document.getElementById('cb-t').value);
            const l = document.getElementById('cb-l').value;
            if(!l || !p) return;
            
            const totalSeeds = (l * p.seeds).toFixed(0);
            const msg = `<strong>${totalSeeds} ${p.seeds < 1 ? 'Kg' : 'Bibit'}</strong><br>Untuk ${l} m¬≤ lahan ${p.name}<br><small>Rasio: ${p.seeds} ${p.seeds < 1 ? 'Kg' : 'bibit'} per m¬≤</small>`;
            tools.showResult('res-benih', msg);
        },
        calcPupuk: () => {
            const p = data.catalog.find(x=>x.id==document.getElementById('cp-t').value);
            const l = document.getElementById('cp-l').value;
            if(!l || !p) return;
            
            const u = (l * p.pupuk.u).toFixed(1);
            const tsp = (l * p.pupuk.tsp).toFixed(1);
            const kcl = (l * p.pupuk.kcl).toFixed(1);
            
            const msg = `<strong>Estimasi Kebutuhan Pupuk:</strong><br>‚Ä¢ Urea: ${u} kg<br>‚Ä¢ TSP: ${tsp} kg<br>‚Ä¢ KCl: ${kcl} kg<br><small>Untuk ${l} m¬≤ lahan ${p.name}</small>`;
            tools.showResult('res-pupuk', msg);
        },
        calcHPT: () => {
            const t = document.getElementById('ch-t').value;
            const d = document.getElementById('ch-d').value;
            if(!t || !d) return;
            
            const total = (t * d).toFixed(1);
            const msg = `<strong>${total} ml obat</strong><br>Campur dengan ${t} Liter air.<br><small>Dosis: ${d} ml per Liter air</small>`;
            tools.showResult('res-hpt', msg);
        },
        calcNPK: () => {
            const p = data.catalog.find(x=>x.id==document.getElementById('cn-t').value);
            const l = document.getElementById('cn-l').value;
            if(!l || !p) return;
            
            const ha = l * 10000; // m2
            const n = (ha * p.npk.n / 1000).toFixed(1);
            const p2 = (ha * p.npk.p / 1000).toFixed(1);
            const k = (ha * p.npk.k / 1000).toFixed(1);
            
            const msg = `<strong>Kebutuhan NPK per ${l} hektar:</strong><br>‚Ä¢ Nitrogen (N): ${n} kg<br>‚Ä¢ Fosfor (P‚ÇÇO‚ÇÖ): ${p2} kg<br>‚Ä¢ Kalium (K‚ÇÇO): ${k} kg<br><small>Rekomendasi untuk ${p.name}</small>`;
            tools.showResult('res-npk', msg);
        },
        showResult: (id, html) => {
            const el = document.getElementById(id);
            el.innerHTML = html;
            el.style.display = 'block';
        }
    };

    // --- DATA MANAGER ---
    const dataMgr = {
        backup: () => {
            const str = "data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(data));
            const a = document.createElement('a'); a.href=str; a.download="agri_v6_topnav.json"; document.body.appendChild(a); a.click(); a.remove();
            alert("‚úÖ Backup berhasil didownload!");
        },
        restore: (input) => {
            const file = input.files[0];
            if(!file) return;
            
            if(!confirm('Data saat ini akan diganti dengan data dari file. Lanjutkan?')) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    data = json;
                    save();
                    alert("‚úÖ Data berhasil dipulihkan!");
                    location.reload();
                } catch(err) {
                    alert("‚ùå File rusak atau tidak valid.");
                }
            };
            reader.readAsText(file);
        }
    };

    // --- INIT APP ---
    app.init();
    document.querySelectorAll('.modal').forEach(m => {
        m.addEventListener('click', (e) => { if(e.target === m) modal.close(); });
    });

</script>
</body>
</html>